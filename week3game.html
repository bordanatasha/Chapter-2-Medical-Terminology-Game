<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardiovascular System Challenge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7f9;
            --glass-bg: rgba(248, 249, 250, 0.75); /* Increased opacity for readability */
            --glass-border: rgba(255, 255, 255, 0.8);
            --text-color: #2c3e50;
            --accent-color: #a02c2c; /* Cardiology Red */
            --accent-color-dark: #802323;
            --correct-color: #27ae60;
            --incorrect-color: #c0392b;
            --danger-color: #c0392b;
            --danger-color-dark: #a03024;
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background-image: url('https://dvl2h13awlxkt.cloudfront.net/assets/general-images/Knowledge/_1200x630_crop_center-center_82_none/iStock-1266230179.jpg?mtime=1713491664');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-color);
        }

        .game-container { width: 100%; max-width: 900px; position: relative; }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--card-shadow);
            padding: 40px 50px; /* Increased padding */
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .screen { display: none; }
        .screen.active { display: block; }
        
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.2em; font-weight: 700; margin-bottom: 5px; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.3);}
        .header p { font-size: 1.1em; font-weight: 500; opacity: 1; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);}
        
        .level-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; }
        .level-card {
            background: rgba(255, 255, 255, 0.5); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); 
            border-radius: 15px; 
            padding: 25px;
            text-align: center; 
            cursor: pointer; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: var(--card-shadow);
        }
        .level-card:hover { transform: translateY(-8px); box-shadow: 0 12px 35px rgba(31, 38, 135, 0.15); }
        .level-card h3 { font-size: 1.5em; font-weight: 600; margin-bottom: 10px; color: var(--accent-color-dark); }
        .level-card p { font-size: 0.95em; line-height: 1.5; opacity: 0.7; }
        
        .shuffle-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 10px;
            font-weight: 500;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 28px; }
        .slider.round:before { border-radius: 50%; }

        .stats-bar { color: white; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 20px; flex-wrap: wrap; gap: 15px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .stat-item { display: flex; align-items: center; gap: 8px; font-size: 1em; font-weight: 500; }
        .stat-item svg { width: 22px; height: 22px; stroke: white; stroke-width: 2; filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.3)); }
        .stat-value { font-weight: 600; }

        .progress-container { margin-bottom: 25px; }
        .progress-bar { width: 100%; height: 8px; background-color: rgba(0, 0, 0, 0.1); border-radius: 4px; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background-color: var(--accent-color); border-radius: 4px; transition: width 0.4s ease-in-out; }
        
        .game-area-wrapper { position: relative; }
        .game-area { min-height: 350px; padding: 10px; }

        .question-text { font-size: 1.6em; font-weight: 600; line-height: 1.4; margin-bottom: 30px; text-align: center; }
        
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .option, .btn-tf {
            background: rgba(255, 255, 255, 0.3); border: 1px solid var(--glass-border); border-radius: 12px;
            padding: 18px 20px; cursor: pointer; transition: all 0.2s ease; font-size: 1em;
        }
        .option:hover, .btn-tf:hover { background: rgba(255, 255, 255, 0.7); border-color: var(--accent-color); }
        
        .option.selected { 
            background-color: var(--accent-color); 
            color: white; 
            border-color: var(--accent-color-dark);
        }

        .btn-tf.selected {
            background-color: var(--accent-color-dark);
            color: white; 
            border-color: var(--accent-color-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .option.correct, .btn-tf.correct { background-color: var(--correct-color); color: white; border-color: var(--correct-color); animation: pulse 0.5s; }
        .option.incorrect, .btn-tf.incorrect { background-color: var(--incorrect-color); color: white; border-color: var(--incorrect-color); animation: shake 0.5s; }

        .fill-in-the-blank-container, .word-dissection-container { text-align: center; }
        .fill-in-the-blank-wrapper { display: inline-flex; align-items: center; }
        .dissection-grid { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .dissection-group { display: flex; flex-direction: column; position: relative;}
        .dissection-group label { margin-bottom: 5px; font-size: 0.9em; opacity: 0.8; }
        .styled-input {
            padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.5); font-size: 1em; font-family: 'Poppins', sans-serif;
            width: 150px; text-align: center; transition: background-color 0.3s ease;
        }
        .styled-input:focus { outline: 2px solid var(--accent-color); }
        
        .correct-answer-feedback { color: var(--correct-color); font-weight: 600; margin-left: 10px; font-size: 0.9em; }
        
        .true-false-container { display: flex; justify-content: center; gap: 20px; }
        
        .matching-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .match-column { display: flex; flex-direction: column; gap: 10px; padding: 10px; border-radius: 10px; min-height: 200px; transition: background-color 0.2s; }
        .match-column.bank { background-color: rgba(0,0,0,0.05); }
        .match-item, .drop-zone {
            padding: 15px; border-radius: 10px; border: 1px solid var(--glass-border); min-height: 50px;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }
        .match-item { background: rgba(255, 255, 255, 0.6); cursor: grab; }
        .match-item.dragging { opacity: 0.5; }
        .drop-zone { border-style: dashed; border-color: rgba(0,0,0,0.2); transition: background-color 0.2s; }
        .drop-zone.drag-over, .match-column.bank.drag-over { background-color: rgba(160, 44, 44, 0.2); }
        
        .controls { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.1); }
        .controls-left, .controls-right { display: flex; align-items: center; gap: 10px; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 1em; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-color-dark); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(160, 44, 44, 0.3); }
        .btn-primary:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .btn-secondary { background: transparent; border: 1px solid var(--text-color); color: var(--text-color); }
        .btn-secondary:hover { background: var(--text-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-color-dark); }
        .btn-icon { background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; }
        .btn-icon svg { width: 28px; height: 28px; stroke: var(--text-color); stroke-width: 1.5; transition: stroke 0.3s; }
        .btn-icon:hover svg { stroke: var(--accent-color); }

        .results-header { text-align: center; margin-bottom: 30px; }
        .results-header h2 { font-size: 2.5em; }
        .results-header p { font-size: 1.2em; opacity: 0.8; }
        .performance-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center; margin-bottom: 30px; }
        .perf-card { background: rgba(255, 255, 255, 0.3); padding: 20px; border-radius: 15px; }
        .perf-card .value { font-size: 2.5em; font-weight: 700; color: var(--accent-color-dark); }
        .perf-card .label { font-size: 0.9em; font-weight: 500; opacity: 0.7; }
        
        .improvement-section { margin-top: 25px; text-align: center; }
        .improvement-section h3 { margin-bottom: 10px; }
        .topic-tags { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .topic-tag { background-color: #e0e0e0; color: #333; padding: 5px 15px; border-radius: 15px; font-size: 0.9em; }

        #reviewContainer {
            margin-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-top: 20px;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }
        .review-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .review-item-status { font-size: 1.5em; }
        .review-item-text { flex-grow: 1; }
        .review-item-text p { font-weight: 500; margin-bottom: 5px; }
        .review-item-text span { font-weight: 400; color: var(--accent-color-dark); }
        
        .pause-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 10; display: none; flex-direction: column;
            justify-content: center; align-items: center; border-radius: 20px;
        }
        .pause-overlay h2 { font-size: 3em; margin-bottom: 20px; }
        .pause-overlay.active { display: flex; }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        @media (max-width: 768px) {
            .glass-panel { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .performance-grid { grid-template-columns: 1fr; }
            .matching-container { grid-template-columns: 1fr; }
            .controls { flex-direction: column; gap: 15px; }
            .dissection-grid { flex-direction: column; align-items: center;}
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div id="menuScreen" class="screen active">
            <div class="header"><h1>Cardiovascular System</h1><p>Select a level to begin your learning session.</p></div>
            <div class="level-selection">
                <div class="level-card" onclick="startQuiz('Beginner')"><h3>Beginner</h3><p>Master the fundamental building blocks and structures of the heart.</p></div>
                <div class="level-card" onclick="startQuiz('Intermediate')"><h3>Intermediate</h3><p>Define and analyze cardiovascular conditions, blood flow, and electrical conduction.</p></div>
                <div class="level-card" onclick="startQuiz('Advanced')"><h3>Advanced</h3><p>Apply your knowledge by analyzing clinical case studies, procedures, and treatments.</p></div>
            </div>
            <div class="shuffle-toggle">
                <label for="shuffleSwitch">Shuffle Questions:</label>
                <label class="switch">
                    <input type="checkbox" id="shuffleSwitch" checked>
                    <span class="slider round"></span>
                </label>
            </div>
        </div>

        <div id="gameScreen" class="screen">
            <div class="stats-bar">
                <div class="stat-item" title="Score"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9a9 9 0 119 0zM12 15.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span id="score" class="stat-value">0</span></div>
                <div class="stat-item" title="Time"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span id="timer" class="stat-value">00:00</span></div>
                <div class="stat-item" title="Progress"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg><span id="progressText" class="stat-value">0/0</span></div>
            </div>
            <div class="progress-container"><div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div></div>
            <div class="glass-panel">
                <div class="game-area-wrapper">
                    <div id="pauseOverlay" class="pause-overlay"><h2>Paused</h2><button class="btn btn-primary" onclick="resumeGame()">Resume</button></div>
                    <div id="gameArea"></div>
                </div>
                <div class="controls">
                    <div class="controls-left">
                        <button class="btn btn-secondary" onclick="showMenu()">Main Menu</button>
                        <button class="btn btn-danger" onclick="endGame(true)">End Now</button>
                    </div>
                    <div class="controls-right">
                        <button class="btn btn-icon" id="pauseBtn" title="Pause" onclick="pauseGame()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-6-13.5v13.5" /></svg></button>
                        <button class="btn btn-icon" id="readAloudBtn" title="Read Aloud"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg></button>
                        <button class="btn btn-primary" id="submitBtn" onclick="checkAnswer()">Submit</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="resultsScreen" class="screen">
            <div class="glass-panel">
                 <div class="results-header">
                    <h2 id="resultsTitle">Quiz Complete!</h2><p id="resultsMessage">Here's how you did.</p>
                </div>
                <div class="performance-grid">
                    <div class="perf-card"><div id="finalScore" class="value">0%</div><div class="label">Accuracy</div></div>
                    <div class="perf-card"><div id="finalQuestions" class="value">0/0</div><div class="label">Correct</div></div>
                     <div class="perf-card"><div id="finalTime" class="value">00:00</div><div class="label">Total Time</div></div>
                </div>
                <div class="improvement-section" id="improvementSection" style="display: none;">
                    <h3>Areas for Improvement</h3><div id="topicTags" class="topic-tags"></div>
                </div>

                <div id="reviewContainer"></div>

                <div class="controls" style="justify-content: center; gap: 15px;">
                    <button class="btn btn-secondary" onclick="showMenu()">Return to Menu</button>
                    <button class="btn btn-primary" id="reviewBtn" onclick="toggleReview()">Review Answers</button>
                </div>
            </div>
        </div>
    </div>

<script>
    const screens = document.querySelectorAll('.screen');
    const gameArea = document.getElementById('gameArea');
    const submitBtn = document.getElementById('submitBtn');
    const readAloudBtn = document.getElementById('readAloudBtn');
    const pauseOverlay = document.getElementById('pauseOverlay');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const progressTextEl = document.getElementById('progressText');
    const progressFillEl = document.getElementById('progressFill');
    const resultsTitle = document.getElementById('resultsTitle');
    const resultsMessage = document.getElementById('resultsMessage');
    const finalScoreEl = document.getElementById('finalScore');
    const finalQuestionsEl = document.getElementById('finalQuestions');
    const finalTimeEl = document.getElementById('finalTime');
    const improvementSection = document.getElementById('improvementSection');
    const topicTags = document.getElementById('topicTags');
    const reviewContainer = document.getElementById('reviewContainer');
    const reviewBtn = document.getElementById('reviewBtn');

    const staticQuizzes = {
        Beginner: {
            questions: [
                { type: "multiple-choice", topic: "Combining Forms", questionText: "Which combining form means 'heart'?", options: ["angi/o", "cardi/o", "phleb/o", "arteri/o"], answer: "cardi/o" },
                { type: "multiple-choice", topic: "Combining Forms", questionText: "Which combining form means 'vein'?", options: ["vas/o", "hem/o", "ven/o", "arteri/o"], answer: "ven/o" },
                { type: "multiple-choice", topic: "Heart Structures", questionText: "What is the sac enclosing the heart?", options: ["Endocardium", "Myocardium", "Epicardium", "Pericardium"], answer: "Pericardium" },
                { type: "multiple-choice", topic: "Heart Structures", questionText: "Which of these is the muscular, middle layer of the heart?", options: ["Endocardium", "Epicardium", "Myocardium", "Pericardium"], answer: "Myocardium" },
                { type: "multiple-choice", topic: "Combining Forms", questionText: "Which combining form means 'blood'?", options: ["phleb/o", "hemat/o", "vas/o", "cardi/o"], answer: "hemat/o" },
                { type: "fill-in-the-blank", topic: "Combining Forms", questionText: "The combining form for 'arteries' is _________.", answer: "arteri/o" },
                { type: "fill-in-the-blank", topic: "Heart Structures", questionText: "The two upper chambers of the heart are called the _________.", answer: "atria" },
                { type: "fill-in-the-blank", topic: "Heart Structures", questionText: "The inner lining of the heart is known as the _________.", answer: "endocardium" },
                { type: "fill-in-the-blank", topic: "Combining Forms", questionText: "The combining form for 'blood vessels' is _________.", answer: "angi/o" },
                { type: "fill-in-the-blank", topic: "Heart Structures", questionText: "The two lower chambers of the heart are the _________.", answer: "ventricles" },
                { type: "true-false", topic: "Heart Structures", questionText: "True or False: The epicardium is the external layer of the heart.", answer: true },
                { type: "true-false", topic: "Combining Forms", questionText: "True or False: 'phleb/o' is a combining form for 'artery'.", answer: false },
                { type: "true-false", topic: "Heart Structures", questionText: "True or False: The atria are the pumping chambers of the heart.", answer: false },
                { type: "true-false", topic: "Heart Structures", questionText: "True or False: The pericardial sac contains fluid to prevent friction.", answer: true },
                { type: "true-false", topic: "Functions", questionText: "True or False: The cardiovascular system returns waste products to the heart.", answer: true },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Break down the term 'endocardium'.", answer: { prefix: "endo", root: "cardi", suffix: "um" }, hint: "Prefix means within, root means heart." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Break down the term 'cardiovascular'.", answer: { root: "cardi/o, vascul", suffix: "ar" }, hint: "Pertaining to the heart and blood vessels." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Break down 'angiography'.", answer: { root: "angi/o", suffix: "graphy" }, hint: "Root means blood vessel." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Break down 'hematology'.", answer: { root: "hemat/o", suffix: "logy" }, hint: "Root means blood." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Break down 'phlebitis'.", answer: { root: "phleb", suffix: "itis" }, hint: "Root means vein." },
                { type: "matching", topic: "Combining Forms", questionText: "Match the combining form to its meaning.", terms: ["cardi/o", "angi/o", "hem/o", "phleb/o"], definitions: ["heart", "blood vessel", "blood", "vein"], answer: { "cardi/o": "heart", "angi/o": "blood vessel", "hem/o": "blood", "phleb/o": "vein" }},
                { type: "matching", topic: "Heart Layers", questionText: "Match the layer of the heart to its description.", terms: ["Epicardium", "Myocardium", "Endocardium"], definitions: ["External layer", "Muscular middle layer", "Inner lining"], answer: { "Epicardium": "External layer", "Myocardium": "Muscular middle layer", "Endocardium": "Inner lining" }},
                { type: "matching", topic: "Heart Chambers", questionText: "Match the chamber to its location.", terms: ["Atria", "Ventricles"], definitions: ["Two upper chambers", "Two lower chambers"], answer: { "Atria": "Two upper chambers", "Ventricles": "Two lower chambers" }},
                { type: "matching", topic: "Combining Forms", questionText: "Match the combining form to the structure.", terms: ["arteri/o", "capill/o", "ven/o"], definitions: ["Arteries", "Capillaries", "Veins"], answer: { "arteri/o": "Arteries", "capill/o": "Capillaries", "ven/o": "Veins" }},
                { type: "matching", topic: "Blood Components", questionText: "Match the component to its description.", terms: ["Erythrocytes", "Leukocytes", "Thrombocytes"], definitions: ["Mature red blood cells", "White blood cells", "Platelets"], answer: { "Erythrocytes": "Mature red blood cells", "Leukocytes": "White blood cells", "Thrombocytes": "Platelets" }}
            ]
        },
        Intermediate: {
            questions: [
                { type: "multiple-choice", topic: "Blood Flow", questionText: "Which valve is located between the right atrium and right ventricle?", options: ["Aortic", "Mitral", "Pulmonary", "Tricuspid"], answer: "Tricuspid" },
                { type: "multiple-choice", topic: "Electrical Conduction", questionText: "What is known as the natural pacemaker of the heart?", options: ["AV Node", "Bundle of His", "SA Node", "Purkinje Fibers"], answer: "SA Node" },
                { type: "multiple-choice", topic: "Blood Pressure", questionText: "The highest pressure against the artery walls occurs during:", options: ["Diastole", "Systole", "Tachycardia", "Bradycardia"], answer: "Systole" },
                { type: "multiple-choice", topic: "Pathology", questionText: "A foreign object, such as a blood clot, circulating in the blood is called a(n):", options: ["Thrombus", "Embolus", "Aneurysm", "Ischemia"], answer: "Embolus" },
                { type: "multiple-choice", topic: "Pathology", questionText: "Which condition is a localized weak spot or balloon-like enlargement of an artery wall?", options: ["Atherosclerosis", "Arrhythmia", "Aneurysm", "Anemia"], answer: "Aneurysm" },
                { type: "fill-in-the-blank", topic: "Blood Flow", questionText: "Blood flows from the left ventricle through the _________ valve into the aorta.", answer: "aortic" },
                { type: "fill-in-the-blank", topic: "Pathology", questionText: "An abnormally slow resting heart rate is known as _________.", answer: "bradycardia" },
                { type: "fill-in-the-blank", topic: "Blood Types", questionText: "The universal donor blood type is _________.", answer: "O" },
                { type: "fill-in-the-blank", topic: "Pathology", questionText: "A blood clot attached to the interior wall of a vessel is a _________.", answer: "thrombus" },
                { type: "fill-in-the-blank", topic: "Electrical Conduction", questionText: "The term for a normal resting heart rate is _________.", answer: "sinus rhythm" },
                { type: "true-false", topic: "Blood Flow", questionText: "True or False: The mitral valve controls blood flow between the left atrium and right ventricle.", answer: false },
                { type: "true-false", topic: "Blood Pressure", questionText: "True or False: Diastole is the phase when the ventricles contract.", answer: false },
                { type: "true-false", topic: "Pathology", questionText: "True or False: Ischemia is a condition of holding back blood from a part of the body.", answer: true },
                { type: "true-false", topic: "Blood Types", questionText: "True or False: Type AB blood is the universal recipient.", answer: true },
                { type: "true-false", topic: "Pathology", questionText: "True or False: An embolism is the blockage of a vessel by an embolus.", answer: true },
                { type: "matching", topic: "Heart Valves", questionText: "Match the valve to its location.", terms: ["Tricuspid", "Pulmonary", "Mitral", "Aortic"], definitions: ["Between right atrium and right ventricle", "Between right ventricle and pulmonary artery", "Between left atrium and left ventricle", "Between left ventricle and aorta"], answer: { "Tricuspid": "Between right atrium and right ventricle", "Pulmonary": "Between right ventricle and pulmonary artery", "Mitral": "Between left atrium and left ventricle", "Aortic": "Between left ventricle and aorta" }},
                { type: "matching", topic: "Electrical Conduction", questionText: "Match the component to its role in the heart's conduction system.", terms: ["SA Node", "AV Node", "Bundle of His", "Purkinje Fibers"], definitions: ["Natural pacemaker", "Transmits impulse to bundle of His", "Transmits impulse to ventricles", "Stimulate myocardial contraction"], answer: { "SA Node": "Natural pacemaker", "AV Node": "Transmits impulse to bundle of His", "Bundle of His": "Transmits impulse to ventricles", "Purkinje Fibers": "Stimulate myocardial contraction" }},
                { type: "matching", topic: "Pathology", questionText: "Match the condition to its description.", terms: ["Arrhythmia", "Bradycardia", "Tachycardia", "Fibrillation"], definitions: ["Abnormal heart rhythm", "Abnormally slow heart rate", "Abnormally fast heart rate", "Rapid, irregular quivering"], answer: { "Arrhythmia": "Abnormal heart rhythm", "Bradycardia": "Abnormally slow heart rate", "Tachycardia": "Abnormally fast heart rate", "Fibrillation": "Rapid, irregular quivering" }},
                { type: "matching", topic: "Blood Types", questionText: "Match the blood type to its characteristic.", terms: ["Type A", "Type B", "Type AB", "Type O"], definitions: ["Has A antigen", "Has B antigen", "Has both A and B antigens", "Has neither A nor B antigens"], answer: { "Type A": "Has A antigen", "Type B": "Has B antigen", "Type AB": "Has both A and B antigens", "Type O": "Has neither A nor B antigens" }},
                { type: "matching", topic: "Pathology", questionText: "Match the term to its meaning.", terms: ["Ischemia", "Thrombosis", "Embolism", "Aneurysm"], definitions: ["Holding back of blood", "Abnormal condition of having a thrombus", "Blockage of a vessel by an embolus", "Localized weak spot in an artery"], answer: { "Ischemia": "Holding back of blood", "Thrombosis": "Abnormal condition of having a thrombus", "Embolism": "Blockage of a vessel by an embolus", "Aneurysm": "Localized weak spot in an artery" }}
            ]
        },
        Advanced: {
            questions: [
                { type: "case-study", topic: "Clinical Cases", questionText: "A patient presents with chest pain. An 'angiography' is ordered. What will this procedure visualize?", options: ["The heart's electrical activity", "The heart valves", "The blood vessels", "The heart muscle"], answer: "The blood vessels" },
                { type: "case-study", topic: "Clinical Cases", questionText: "A patient is prescribed an 'ACE inhibitor'. This medication is primarily used to treat:", options: ["High cholesterol", "Arrhythmias", "Hypertension", "Blood clots"], answer: "Hypertension" },
                { type: "case-study", topic: "Clinical Cases", questionText: "During an EKG, the P wave represents:", options: ["Contraction of the ventricles", "Relaxation of the atria", "Contraction of the atria", "Relaxation of the ventricles"], answer: "Contraction of the atria" },
                { type: "case-study", topic: "Clinical Cases", questionText: "A surgeon performs a 'valvuloplasty'. What is being repaired?", options: ["An artery", "A heart valve", "A vein", "The septum"], answer: "A heart valve" },
                { type: "case-study", topic: "Clinical Cases", questionText: "A patient is diagnosed with 'cardiomegaly'. This means the patient has:", options: ["An enlarged heart", "Inflammation of the heart", "A slow heart rate", "A fast heart rate"], answer: "An enlarged heart" },
                { type: "multiple-choice", topic: "Diagnostic Procedures", questionText: "Which diagnostic procedure uses ultrasound to evaluate the structures of the heart?", options: ["Electrocardiogram", "Echocardiogram", "Angiography", "Cardiac catheterization"], answer: "Echocardiogram" },
                { type: "multiple-choice", topic: "Treatments", questionText: "Which type of medication is administered to reduce the workload of the heart by slowing the heart rate?", options: ["Diuretic", "Anticoagulant", "Beta-blocker", "ACE inhibitor"], answer: "Beta-blocker" },
                { type: "multiple-choice", topic: "Diagnostic Procedures", questionText: "A 'Holter monitor' is used to:", options: ["Measure blood pressure over 24 hours", "Record heart rhythms for 24-48 hours", "Visualize coronary arteries", "Assess valve function"], answer: "Record heart rhythms for 24-48 hours" },
                { type: "multiple-choice", topic: "Treatments", questionText: "What does an 'automated external defibrillator' (AED) do?", options: ["It provides artificial respiration", "It shocks the heart to restore normal rhythm", "It surgically repairs a heart valve", "It dissolves blood clots"], answer: "It shocks the heart to restore normal rhythm" },
                { type: "multiple-choice", topic: "Treatments", questionText: "The surgical removal of plaque buildup from the interior of an artery is called a(n):", options: ["Atherectomy", "Angioplasty", "Stent", "Aneurysmectomy"], answer: "Atherectomy" },
                { type: "fill-in-the-blank", topic: "Diagnostic Procedures", questionText: "The record of the electrical activity of the myocardium is an _________.", answer: "electrocardiogram" },
                { type: "fill-in-the-blank", topic: "Treatments", questionText: "A wire-mesh tube placed in an artery to provide support is a _________.", answer: "stent" },
                { type: "fill-in-the-blank", topic: "Treatments", questionText: "A medication administered to stimulate the kidneys to increase urine secretion is a _________.", answer: "diuretic" },
                { type: "fill-in-the-blank", topic: "Treatments", questionText: "The surgical removal of an aneurysm is an _________.", answer: "aneurysmectomy" },
                { type: "fill-in-the-blank", topic: "Treatments", questionText: "The use of electrical shock to restore the heart's normal rhythm is _________.", answer: "defibrillation" },
                { type: "true-false", topic: "Treatments", questionText: "True or False: An anticoagulant slows coagulation and prevents new clots from forming.", answer: true },
                { type: "true-false", topic: "Diagnostic Procedures", questionText: "True or False: An electrocardiogram is a recording of the heart's structure.", answer: false },
                { type: "true-false", topic: "Treatments", questionText: "True or False: Cardiopulmonary resuscitation (CPR) involves shocking the heart.", answer: false },
                { type: "true-false", topic: "Treatments", questionText: "True or False: A beta-blocker is used to increase heart rate.", answer: false },
                { type: "true-false", topic: "Diagnostic Procedures", questionText: "True or False: Angiography is a type of blood test.", answer: false }
            ]
        }
    };

    let gameState = {};

    function showScreen(screenId) { screens.forEach(s => s.style.display = s.id === screenId ? 'block' : 'none'); }
    function shuffleArray(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]]; } return a; }
    function formatTime(s) { const m = Math.floor(s / 60); const sec = s % 60; return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`; }

    function resetGameState() {
        if (gameState.timerInterval) clearInterval(gameState.timerInterval);
        speechSynthesis.cancel();
        gameState = {
            level: '', questions: [], currentQuestionIndex: 0, score: 0, time: 0,
            timerInterval: null, answeredQuestions: []
        };
    }

    function startQuiz(level) {
        resetGameState();
        gameState.level = level;
        const shuffleEnabled = document.getElementById('shuffleSwitch').checked;
        let questionsForLevel = JSON.parse(JSON.stringify(staticQuizzes[level].questions));
        if (shuffleEnabled) {
            gameState.questions = shuffleArray(questionsForLevel);
        } else {
            gameState.questions = questionsForLevel;
        }
        showScreen('gameScreen');
        startTimer();
        displayQuestion();
    }
    
    function startTimer() {
        if (gameState.timerInterval) clearInterval(gameState.timerInterval);
        gameState.timerInterval = setInterval(() => { gameState.time++; timerEl.textContent = formatTime(gameState.time); }, 1000);
    }
    
    function pauseGame() {
        clearInterval(gameState.timerInterval);
        pauseOverlay.classList.add('active');
    }

    function resumeGame() {
        pauseOverlay.classList.remove('active');
        startTimer();
    }

    function displayQuestion() {
        speechSynthesis.cancel();
        if (gameState.currentQuestionIndex >= gameState.questions.length) {
            endGame(); return;
        }
        const q = gameState.questions[gameState.currentQuestionIndex];
        gameArea.innerHTML = '';
        
        switch (q.type) {
            case 'multiple-choice':
            case 'case-study':
                renderMultipleChoice(q);
                break;
            case 'matching':
                renderMatching(q);
                break;
            case 'fill-in-the-blank':
                renderFillInTheBlank(q);
                break;
            case 'true-false':
                renderTrueFalse(q);
                break;
            case 'word-dissection':
                renderWordDissection(q);
                break;
        }

        updateStats();
        submitBtn.disabled = true;
        readAloudBtn.onclick = () => {
            speechSynthesis.cancel(); 
            let textToSpeak = q.questionText;
            if(q.type === 'fill-in-the-blank') {
                textToSpeak = q.questionText.replace('_________', 'blank');
            } else if (q.options) {
                textToSpeak += ". The options are: " + q.options.join(', ');
            } else if (q.type === 'true-false') {
                // No extra text needed
            } else if (q.type === 'matching') {
                textToSpeak += ". The items to match are: " + q.terms.join(', ');
            }
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            speechSynthesis.speak(utterance);
        };
    }

    function renderMultipleChoice(q) {
        gameArea.innerHTML = `<p class="question-text">${q.questionText}</p><div class="options-grid">${shuffleArray([...q.options]).map(opt => `<div class="option" data-value="${opt}">${opt}</div>`).join('')}</div>`;
        document.querySelectorAll('.option').forEach(opt => opt.addEventListener('click', () => {
            document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            submitBtn.disabled = false;
        }));
    }

    function renderTrueFalse(q) {
        gameArea.innerHTML = `<p class="question-text">${q.questionText}</p>
            <div class="true-false-container">
                <button class="btn btn-primary btn-tf" data-value="true">True</button>
                <button class="btn btn-primary btn-tf" data-value="false">False</button>
            </div>`;
        document.querySelectorAll('.btn-tf').forEach(btn => btn.addEventListener('click', () => {
             document.querySelectorAll('.btn-tf').forEach(b => b.classList.remove('selected'));
             btn.classList.add('selected');
             submitBtn.disabled = false;
        }));
    }
    
    function renderFillInTheBlank(q) {
        const parts = q.questionText.split('_________');
        gameArea.innerHTML = `<div class="fill-in-the-blank-container">
            <p class="question-text">${parts[0]}<span class="fill-in-the-blank-wrapper"><input type="text" id="fillBlankInput" class="styled-input" placeholder="Type answer"></span>${parts.length > 1 ? parts[1] : ''}</p>
        </div>`;
        document.getElementById('fillBlankInput').addEventListener('input', () => {
             submitBtn.disabled = document.getElementById('fillBlankInput').value.trim() === '';
        });
    }

    function renderWordDissection(q) {
        gameArea.innerHTML = `<p class="question-text">${q.questionText}</p>
            <div class="word-dissection-container">
                <div class="dissection-grid">
                    ${'prefix' in q.answer ? `<div class="dissection-group"><label>Prefix</label><input type="text" id="prefixInput" class="styled-input"></div>` : ''}
                    ${'root' in q.answer ? `<div class="dissection-group"><label>Root</label><input type="text" id="rootInput" class="styled-input"></div>` : ''}
                    ${'suffix' in q.answer ? `<div class="dissection-group"><label>Suffix</label><input type="text" id="suffixInput" class="styled-input"></div>` : ''}
                </div>
                ${q.hint ? `<p style="font-size:0.9em; opacity:0.7; margin-top:15px;">Hint: ${q.hint}</p>` : ''}
            </div>`;
        document.querySelectorAll('.styled-input').forEach(input => input.addEventListener('input', () => {
            submitBtn.disabled = false;
        }));
    }

    function renderMatching(q) {
        const termsHTML = shuffleArray([...q.terms]).map(term => `<div class="match-item" draggable="true" data-term="${term}">${term}</div>`).join('');
        const defsHTML = q.definitions.map(def => `<div class="drop-zone" data-definition="${def}">${def}</div>`).join('');
        gameArea.innerHTML = `<p class="question-text">${q.questionText}</p><div class="matching-container"><div class="match-column bank">${termsHTML}</div><div class="match-column">${defsHTML}</div></div>`;
        setupDragAndDrop();
    }

    function setupDragAndDrop() {
        const draggables = document.querySelectorAll('.match-item');
        const dropZones = document.querySelectorAll('.match-column, .drop-zone');
        let draggedItem = null;

        draggables.forEach(d => {
            d.addEventListener('dragstart', () => { draggedItem = d; setTimeout(() => d.classList.add('dragging'), 0); });
            d.addEventListener('dragend', () => { d.classList.remove('dragging'); if (Array.from(document.querySelectorAll('.bank .match-item')).length === 0) { submitBtn.disabled = false; }});
        });

        dropZones.forEach(zone => {
            zone.addEventListener('dragover', e => { e.preventDefault(); if(zone.children.length === 0 || zone.classList.contains('bank')) { zone.classList.add('drag-over'); } });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', e => {
                e.preventDefault(); zone.classList.remove('drag-over');
                if (zone.children.length > 0 && !zone.classList.contains('bank')) { return; }
                zone.appendChild(draggedItem);
            });
        });
    }

    function updateStats() {
        scoreEl.textContent = Math.round(gameState.score);
        progressTextEl.textContent = `${gameState.currentQuestionIndex + 1}/${gameState.questions.length}`;
        progressFillEl.style.width = `${((gameState.currentQuestionIndex + 1) / gameState.questions.length) * 100}%`;
    }

    function checkAnswer() {
        const q = gameState.questions[gameState.currentQuestionIndex];
        let isCorrect = false;

        switch (q.type) {
            case 'multiple-choice':
            case 'case-study':
                const selected = document.querySelector('.option.selected');
                if (!selected) return;
                isCorrect = selected.dataset.value.toLowerCase() === q.answer.toLowerCase();
                if(isCorrect) gameState.score += 10;
                selected.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (!isCorrect) document.querySelectorAll('.option').forEach(opt => { if (opt.dataset.value.toLowerCase() === q.answer.toLowerCase()) opt.classList.add('correct'); });
                break;
            case 'true-false':
                const selectedBtn = document.querySelector('.btn-tf.selected');
                 if (!selectedBtn) return;
                isCorrect = (selectedBtn.dataset.value === 'true') === q.answer;
                if(isCorrect) gameState.score += 10;
                selectedBtn.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (!isCorrect) {
                    document.querySelectorAll('.btn-tf').forEach(btn => {
                        if ((btn.dataset.value === 'true') === q.answer) {
                            btn.classList.add('correct');
                        }
                    });
                }
                break;
            case 'fill-in-the-blank':
                const inputEl = document.getElementById('fillBlankInput');
                const wrapper = document.querySelector('.fill-in-the-blank-wrapper');
                isCorrect = inputEl.value.trim().toLowerCase() === q.answer.toLowerCase();
                if(isCorrect) gameState.score += 10;
                inputEl.style.backgroundColor = isCorrect ? '#d4edda' : '#f8d7da';
                if (!isCorrect) {
                    const feedback = document.createElement('span');
                    feedback.className = 'correct-answer-feedback';
                    feedback.textContent = `(${q.answer})`;
                    wrapper.appendChild(feedback);
                }
                break;
            case 'word-dissection':
                 isCorrect = true;
                 const prefixInput = document.getElementById('prefixInput');
                 const rootInput = document.getElementById('rootInput');
                 const suffixInput = document.getElementById('suffixInput');

                 if (prefixInput && 'prefix' in q.answer) {
                     if (prefixInput.value.trim().toLowerCase() !== q.answer.prefix) {
                        prefixInput.style.backgroundColor = '#f8d7da';
                        if(!prefixInput.value) prefixInput.placeholder = `Ans: ${q.answer.prefix}`;
                        isCorrect = false;
                     } else {
                        prefixInput.style.backgroundColor = '#d4edda';
                     }
                 }
                 if (rootInput && 'root' in q.answer) {
                     if (rootInput.value.trim().toLowerCase() !== q.answer.root) {
                        rootInput.style.backgroundColor = '#f8d7da';
                        if(!rootInput.value) rootInput.placeholder = `Ans: ${q.answer.root}`;
                        isCorrect = false;
                     } else {
                        rootInput.style.backgroundColor = '#d4edda';
                     }
                 }
                 if (suffixInput && 'suffix' in q.answer) {
                     if (suffixInput.value.trim().toLowerCase() !== q.answer.suffix) {
                        suffixInput.style.backgroundColor = '#f8d7da';
                        if(!suffixInput.value) suffixInput.placeholder = `Ans: ${q.answer.suffix}`;
                        isCorrect = false;
                     } else {
                        suffixInput.style.backgroundColor = '#d4edda';
                     }
                 }
                 if(isCorrect) gameState.score += 10;
                 break;
            case 'matching':
                let correctMatches = 0;
                const totalMatches = Object.keys(q.answer).length;
                document.querySelectorAll('.drop-zone').forEach(z => {
                    const termItem = z.querySelector('.match-item');
                    if (termItem && q.answer[termItem.dataset.term] === z.dataset.definition) {
                        correctMatches++; 
                        z.style.borderColor = 'var(--correct-color)';
                        termItem.style.borderColor = 'var(--correct-color)';
                    } else if (termItem) { 
                        z.style.borderColor = 'var(--incorrect-color)'; 
                        termItem.style.borderColor = 'var(--incorrect-color)';
                    }
                });
                isCorrect = correctMatches === totalMatches;
                if (correctMatches > 0) {
                    gameState.score += (correctMatches / totalMatches) * 10;
                }
                break;
        }
        
        gameState.answeredQuestions.push({ question: q, isCorrect: isCorrect });
        updateStats();
        document.querySelectorAll('.option, .match-item, .styled-input, .btn-tf').forEach(el => el.style.pointerEvents = 'none');
        submitBtn.disabled = true;
        setTimeout(() => { gameState.currentQuestionIndex++; displayQuestion(); }, isCorrect ? 2000 : 3000);
    }
    
    function endGame(forceEnd = false) {
        clearInterval(gameState.timerInterval);
        speechSynthesis.cancel();
        showScreen('resultsScreen');

        const questionsAttempted = gameState.answeredQuestions.length;
        const correctAnswers = gameState.answeredQuestions.filter(q => q.isCorrect).length;
        
        const accuracy = questionsAttempted > 0 ? Math.round((correctAnswers / questionsAttempted) * 100) : 0;
        finalScoreEl.textContent = `${accuracy}%`;
        finalQuestionsEl.textContent = `${correctAnswers}/${questionsAttempted}`;
        finalTimeEl.textContent = formatTime(gameState.time);

        if (questionsAttempted === 0) {
            resultsMessage.textContent = "You didn't answer any questions.";
            improvementSection.style.display = 'none';
            reviewBtn.style.display = 'none';
            return;
        }
        
        reviewBtn.style.display = 'inline-block';
        if (accuracy === 100) { resultsTitle.textContent = "Excellent!"; resultsMessage.textContent = "Your diagnostic skills are top-tier."; }
        else if (accuracy >= 70) { resultsTitle.textContent = "Well Done!"; resultsMessage.textContent = "You have a solid grasp of cardiovascular concepts."; }
        else { resultsTitle.textContent = "Good Effort!"; resultsMessage.textContent = "Time to hit the books and review your weak areas."; }

        const incorrectTopics = new Set(gameState.answeredQuestions.filter(q => !q.isCorrect).map(q => q.question.topic));
        if (incorrectTopics.size > 0) {
            improvementSection.style.display = 'block';
            topicTags.innerHTML = [...incorrectTopics].map(topic => `<span class="topic-tag">${topic}</span>`).join('');
        } else {
            improvementSection.style.display = 'none';
        }

        populateReview();
    }
    
    function populateReview() {
        reviewContainer.innerHTML = '<h3>Answer Review</h3>';
        gameState.answeredQuestions.forEach(item => {
            const correctAnsString = (q) => {
                if (q.type === 'true-false') {
                    return q.answer ? 'True' : 'False';
                }
                if (typeof q.answer === 'object') {
                    if(q.type === 'word-dissection') {
                        let parts = [];
                        if(q.answer.prefix) parts.push(`Prefix: ${q.answer.prefix}`);
                        if(q.answer.root) parts.push(`Root: ${q.answer.root}`);
                        if(q.answer.suffix) parts.push(`Suffix: ${q.answer.suffix}`);
                        return parts.join(', ');
                    }
                    return "See matched pairs";
                }
                return q.answer;
            };

            const reviewItem = document.createElement('div');
            reviewItem.className = 'review-item';
            reviewItem.innerHTML = `
                <div class="review-item-status">${item.isCorrect ? '✔️' : '❌'}</div>
                <div class="review-item-text">
                    <p>${item.question.questionText}</p>
                    <span>Correct Answer: ${correctAnsString(item.question)}</span>
                </div>
            `;
            reviewContainer.appendChild(reviewItem);
        });
    }
    
    function toggleReview() {
        const isHidden = reviewContainer.style.display === 'none' || reviewContainer.style.display === '';
        reviewContainer.style.display = isHidden ? 'block' : 'none';
        reviewBtn.textContent = isHidden ? 'Hide Review' : 'Review Answers';
    }

    function showMenu() { 
        resetGameState(); 
        reviewContainer.style.display = 'none';
        reviewBtn.textContent = 'Review Answers';
        showScreen('menuScreen'); 
    }
</script>

</body>
</html>