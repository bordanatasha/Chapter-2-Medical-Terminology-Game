<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Terminology Challenge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7f9;
            --glass-bg: rgba(255, 255, 255, 0.45);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-color: #2c3e50;
            --accent-color: #008080;
            --accent-color-dark: #006666;
            --correct-color: #27ae60;
            --incorrect-color: #c0392b;
            --danger-color: #c0392b;
            --danger-color-dark: #a03024;
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23dce4ec" fill-opacity="0.4"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-color);
        }

        .game-container { width: 100%; max-width: 900px; position: relative; }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--card-shadow);
            padding: 30px 40px;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .screen { display: none; }
        .screen.active { display: block; }
        
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.2em; font-weight: 700; margin-bottom: 5px; }
        .header p { font-size: 1.1em; font-weight: 300; opacity: 0.8; }
        
        .level-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; }
        .level-card {
            background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); border-radius: 15px; padding: 25px;
            text-align: center; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: var(--card-shadow);
        }
        .level-card:hover { transform: translateY(-8px); box-shadow: 0 12px 35px rgba(31, 38, 135, 0.15); }
        .level-card h3 { font-size: 1.5em; font-weight: 600; margin-bottom: 10px; color: var(--accent-color-dark); }
        .level-card p { font-size: 0.95em; line-height: 1.5; opacity: 0.7; }
        
        .shuffle-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 10px;
            font-weight: 500;
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 28px; }
        .slider.round:before { border-radius: 50%; }

        .stats-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 20px; flex-wrap: wrap; gap: 15px; }
        .stat-item { display: flex; align-items: center; gap: 8px; font-size: 1em; font-weight: 500; }
        .stat-item svg { width: 22px; height: 22px; stroke: var(--accent-color); stroke-width: 2; }
        .stat-value { font-weight: 600; }

        .progress-container { margin-bottom: 25px; }
        .progress-bar { width: 100%; height: 8px; background-color: rgba(0, 0, 0, 0.1); border-radius: 4px; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background-color: var(--accent-color); border-radius: 4px; transition: width 0.4s ease-in-out; }
        
        .game-area-wrapper { position: relative; }
        .game-area { min-height: 350px; padding: 10px; }

        .question-text { font-size: 1.6em; font-weight: 600; line-height: 1.4; margin-bottom: 30px; text-align: center; }
        
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .option, .btn-tf {
            background: rgba(255, 255, 255, 0.3); border: 1px solid var(--glass-border); border-radius: 12px;
            padding: 18px 20px; cursor: pointer; transition: all 0.2s ease; font-size: 1em;
        }
        .option:hover, .btn-tf:hover { background: rgba(255, 255, 255, 0.7); border-color: var(--accent-color); }
        
        .option.selected { 
            background-color: var(--accent-color); 
            color: white; 
            border-color: var(--accent-color-dark);
        }

        .btn-tf.selected {
            background-color: var(--accent-color-dark); /* Darker color for selection */
            color: white; 
            border-color: var(--accent-color-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .option.correct, .btn-tf.correct { background-color: var(--correct-color); color: white; border-color: var(--correct-color); animation: pulse 0.5s; }
        .option.incorrect, .btn-tf.incorrect { background-color: var(--incorrect-color); color: white; border-color: var(--incorrect-color); animation: shake 0.5s; }

        .fill-in-the-blank-container, .word-dissection-container { text-align: center; }
        .fill-in-the-blank-wrapper { display: inline-flex; align-items: center; }
        .dissection-grid { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .dissection-group { display: flex; flex-direction: column; position: relative;}
        .dissection-group label { margin-bottom: 5px; font-size: 0.9em; opacity: 0.8; }
        .styled-input {
            padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.5); font-size: 1em; font-family: 'Poppins', sans-serif;
            width: 150px; text-align: center; transition: background-color 0.3s ease;
        }
        .styled-input:focus { outline: 2px solid var(--accent-color); }
        
        .correct-answer-feedback { color: var(--correct-color); font-weight: 600; margin-left: 10px; font-size: 0.9em; }
        
        .true-false-container { display: flex; justify-content: center; gap: 20px; }
        
        .matching-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .match-column { display: flex; flex-direction: column; gap: 10px; padding: 10px; border-radius: 10px; min-height: 200px; transition: background-color 0.2s; }
        .match-column.bank { background-color: rgba(0,0,0,0.05); }
        .match-item, .drop-zone {
            padding: 15px; border-radius: 10px; border: 1px solid var(--glass-border); min-height: 50px;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }
        .match-item { background: rgba(255, 255, 255, 0.6); cursor: grab; }
        .match-item.dragging { opacity: 0.5; }
        .drop-zone { border-style: dashed; border-color: rgba(0,0,0,0.2); transition: background-color 0.2s; }
        .drop-zone.drag-over, .match-column.bank.drag-over { background-color: rgba(0, 128, 128, 0.2); }
        
        .controls { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.1); }
        .controls-left, .controls-right { display: flex; align-items: center; gap: 10px; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 1em; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-color-dark); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 128, 128, 0.3); }
        .btn-primary:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .btn-secondary { background: transparent; border: 1px solid var(--text-color); color: var(--text-color); }
        .btn-secondary:hover { background: var(--text-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-color-dark); }
        .btn-icon { background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; }
        .btn-icon svg { width: 28px; height: 28px; stroke: var(--text-color); stroke-width: 1.5; transition: stroke 0.3s; }
        .btn-icon:hover svg { stroke: var(--accent-color); }

        .results-header { text-align: center; margin-bottom: 30px; }
        .results-header h2 { font-size: 2.5em; }
        .results-header p { font-size: 1.2em; opacity: 0.8; }
        .performance-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center; margin-bottom: 30px; }
        .perf-card { background: rgba(255, 255, 255, 0.3); padding: 20px; border-radius: 15px; }
        .perf-card .value { font-size: 2.5em; font-weight: 700; color: var(--accent-color-dark); }
        .perf-card .label { font-size: 0.9em; font-weight: 500; opacity: 0.7; }
        
        .improvement-section { margin-top: 25px; text-align: center; }
        .improvement-section h3 { margin-bottom: 10px; }
        .topic-tags { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .topic-tag { background-color: #e0e0e0; color: #333; padding: 5px 15px; border-radius: 15px; font-size: 0.9em; }

        #reviewContainer {
            margin-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-top: 20px;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }
        .review-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .review-item-status { font-size: 1.5em; }
        .review-item-text { flex-grow: 1; }
        .review-item-text p { font-weight: 500; margin-bottom: 5px; }
        .review-item-text span { font-weight: 400; color: var(--accent-color-dark); }
        
        .pause-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 10; display: none; flex-direction: column;
            justify-content: center; align-items: center; border-radius: 20px;
        }
        .pause-overlay h2 { font-size: 3em; margin-bottom: 20px; }
        .pause-overlay.active { display: flex; }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        @media (max-width: 768px) {
            .glass-panel { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .performance-grid { grid-template-columns: 1fr; }
            .matching-container { grid-template-columns: 1fr; }
            .controls { flex-direction: column; gap: 15px; }
            .dissection-grid { flex-direction: column; align-items: center;}
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div id="menuScreen" class="screen active">
            <div class="header"><h1>Medical Terminology Challenge</h1><p>Select a level to begin your learning session.</p></div>
            <div class="level-selection">
                <div class="level-card" onclick="startQuiz('Beginner')"><h3>Beginner</h3><p>Master the fundamental building blocks: prefixes, suffixes, and word roots.</p></div>
                <div class="level-card" onclick="startQuiz('Intermediate')"><h3>Intermediate</h3><p>Define and analyze complete medical terms used in clinical practice.</p></div>
                <div class="level-card" onclick="startQuiz('Advanced')"><h3>Advanced</h3><p>Apply your knowledge by analyzing realistic clinical case studies.</p></div>
            </div>
            <div class="shuffle-toggle">
                <label for="shuffleSwitch">Shuffle Questions:</label>
                <label class="switch">
                    <input type="checkbox" id="shuffleSwitch" checked>
                    <span class="slider round"></span>
                </label>
            </div>
        </div>

        <div id="gameScreen" class="screen">
            <div class="stats-bar">
                <div class="stat-item" title="Score"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9a9 9 0 119 0zM12 15.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span id="score" class="stat-value">0</span></div>
                <div class="stat-item" title="Time"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span id="timer" class="stat-value">00:00</span></div>
                <div class="stat-item" title="Progress"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg><span id="progressText" class="stat-value">0/0</span></div>
            </div>
            <div class="progress-container"><div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div></div>
            <div class="glass-panel">
                <div class="game-area-wrapper">
                    <div id="pauseOverlay" class="pause-overlay"><h2>Paused</h2><button class="btn btn-primary" onclick="resumeGame()">Resume</button></div>
                    <div id="gameArea"></div>
                </div>
                <div class="controls">
                    <div class="controls-left">
                        <button class="btn btn-secondary" onclick="showMenu()">Main Menu</button>
                        <button class="btn btn-danger" onclick="endGame(true)">End Now</button>
                    </div>
                    <div class="controls-right">
                        <button class="btn btn-icon" id="pauseBtn" title="Pause" onclick="pauseGame()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-6-13.5v13.5" /></svg></button>
                        <button class="btn btn-icon" id="readAloudBtn" title="Read Aloud"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg></button>
                        <button class="btn btn-primary" id="submitBtn" onclick="checkAnswer()">Submit</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="resultsScreen" class="screen">
            <div class="glass-panel">
                 <div class="results-header">
                    <h2 id="resultsTitle">Quiz Complete!</h2><p id="resultsMessage">Here's how you did.</p>
                </div>
                <div class="performance-grid">
                    <div class="perf-card"><div id="finalScore" class="value">0</div><div class="label">Final Score</div></div>
                    <div class="perf-card"><div id="finalQuestions" class="value">0/0</div><div class="label">Correct</div></div>
                     <div class="perf-card"><div id="finalTime" class="value">00:00</div><div class="label">Total Time</div></div>
                </div>
                <div class="improvement-section" id="improvementSection" style="display: none;">
                    <h3>Areas for Improvement</h3><div id="topicTags" class="topic-tags"></div>
                </div>

                <div id="reviewContainer"></div>

                <div class="controls" style="justify-content: center; gap: 15px;">
                    <button class="btn btn-secondary" onclick="showMenu()">Return to Menu</button>
                    <button class="btn btn-primary" id="reviewBtn" onclick="toggleReview()">Review Answers</button>
                </div>
            </div>
        </div>
    </div>

<script>
    const screens = document.querySelectorAll('.screen');
    const gameArea = document.getElementById('gameArea');
    const submitBtn = document.getElementById('submitBtn');
    const readAloudBtn = document.getElementById('readAloudBtn');
    const pauseOverlay = document.getElementById('pauseOverlay');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const progressTextEl = document.getElementById('progressText');
    const progressFillEl = document.getElementById('progressFill');
    const resultsTitle = document.getElementById('resultsTitle');
    const resultsMessage = document.getElementById('resultsMessage');
    const finalScoreEl = document.getElementById('finalScore');
    const finalQuestionsEl = document.getElementById('finalQuestions');
    const finalTimeEl = document.getElementById('finalTime');
    const improvementSection = document.getElementById('improvementSection');
    const topicTags = document.getElementById('topicTags');
    const reviewContainer = document.getElementById('reviewContainer');
    const reviewBtn = document.getElementById('reviewBtn');

    const staticQuizzes = {
        Beginner: {
            questions: [
                { type: "multiple-choice", topic: "Basic Anatomy", questionText: "What is the study of the structures of the body?", options: ["Physiology", "Cytology", "Anatomy", "Histology"], answer: "Anatomy" },
                { type: "multiple-choice", topic: "Body Planes", questionText: "Which plane divides the body into equal left and right halves?", options: ["Frontal", "Transverse", "Midsagittal", "Coronal"], answer: "Midsagittal" },
                { type: "multiple-choice", topic: "Directional Terms", questionText: "The term 'ventral' refers to which side of the body?", options: ["The back", "The front (belly side)", "The side", "The top"], answer: "The front (belly side)" },
                { type: "multiple-choice", topic: "Prefixes & Suffixes", questionText: "In the word 'physiology', the suffix '-ology' means:", options: ["The study of", "Nature or physical", "Pertaining to", "Process"], answer: "The study of" },
                { type: "multiple-choice", topic: "Basic Anatomy", questionText: "Which of these is NOT a primary anatomic reference system?", options: ["Body planes", "Body directions", "Body systems", "Body cavities"], answer: "Body systems" },
                { type: "fill-in-the-blank", topic: "Body Organization", questionText: "The basic structural and functional unit of the body is the _________.", answer: "Cell" },
                { type: "fill-in-the-blank", topic: "Body Planes", questionText: "The imaginary vertical and horizontal lines used to divide the body are known as body _________.", answer: "planes" },
                { type: "fill-in-the-blank", topic: "Body Organization", questionText: "A group of specialized cells that work together is called a _________.", answer: "Tissue" },
                { type: "fill-in-the-blank", topic: "Basic Anatomy", questionText: "The study of the functions of body structures is known as _________.", answer: "Physiology" },
                { type: "fill-in-the-blank", topic: "Basic Anatomy", questionText: "The position where the body is erect and facing forward is the _________ position.", answer: "anatomic" },
                { type: "true-false", topic: "Basic Anatomy", questionText: "True or False: In the anatomic position, the palms of the hands are facing backward.", answer: false },
                { type: "true-false", topic: "Directional Terms", questionText: "True or False: The term 'superior' means toward the feet.", answer: false },
                { type: "true-false", topic: "Body Planes", questionText: "True or False: A transverse plane divides the body into anterior and posterior portions.", answer: false },
                { type: "true-false", topic: "Body Organization", questionText: "True or False: The study of cells is known as cytology.", answer: true },
                { type: "true-false", topic: "Directional Terms", questionText: "True or False: 'Anterior' and 'ventral' are terms that can often be used interchangeably.", answer: true },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Break down the term 'gastritis'.", answer: { root: "gastr", suffix: "itis" }, hint: "Root means stomach, suffix means inflammation." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Break down the term 'adenectomy'.", answer: { root: "aden", suffix: "ectomy" }, hint: "Root means gland, suffix means surgical removal." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Break down the term 'ventral'.", answer: { root: "ventr", suffix: "al" }, hint: "Root means belly side." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Break down the term 'cephalic'.", answer: { root: "cephal", suffix: "ic" }, hint: "Root means head." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "In the word 'dorsal', what does the suffix '-al' mean?", answer: { suffix: "pertaining to" }, hint: "This suffix is very common." },
                { type: "matching", topic: "Directional Terms", questionText: "Match the directional term to its meaning.", terms: ["Anterior", "Posterior", "Superior", "Inferior"], definitions: ["Front of the body", "Back of the body", "Toward the head", "Toward the feet"], answer: { "Anterior": "Front of the body", "Posterior": "Back of the body", "Superior": "Toward the head", "Inferior": "Toward the feet" }},
                { type: "matching", topic: "Body Planes", questionText: "Match the body plane to its description.", terms: ["Frontal", "Transverse", "Midsagittal"], definitions: ["Divides into front/back", "Divides into upper/lower", "Divides into equal left/right"], answer: { "Frontal": "Divides into front/back", "Transverse": "Divides into upper/lower", "Midsagittal": "Divides into equal left/right" }},
                { type: "matching", topic: "Body Regions", questionText: "Match the abdominal quadrant to a key organ found within it.", terms: ["RUQ", "LUQ", "RLQ", "LLQ"], definitions: ["Liver", "Stomach", "Appendix", "Parts of the intestine"], answer: { "RUQ": "Liver", "LUQ": "Stomach", "RLQ": "Appendix", "LLQ": "Parts of the intestine" }},
                { type: "matching", topic: "Prefixes & Suffixes", questionText: "Match the prefix/suffix to its meaning.", terms: ["physi", "-ology", "dors", "ventr"], definitions: ["Nature or physical", "Study of", "Back", "Belly side"], answer: { "physi": "Nature or physical", "-ology": "Study of", "dors": "Back", "ventr": "Belly side" }},
                { type: "matching", topic: "Body Organization", questionText: "Match the structural unit to its description.", terms: ["Cell", "Tissue", "Organ"], definitions: ["The basic unit of life", "A group of similar cells", "A structure of different tissues"], answer: { "Cell": "The basic unit of life", "Tissue": "A group of similar cells", "Organ": "A structure of different tissues" }}
            ]
        },
        Intermediate: {
            questions: [
                { type: "multiple-choice", topic: "Cell Pathology", questionText: "The congenital absence of an organ or tissue is known as:", options: ["Hypoplasia", "Aplasia", "Dysplasia", "Anaplasia"], answer: "Aplasia" },
                { type: "multiple-choice", topic: "Body Cavities", questionText: "The heart and lungs are located in which body cavity?", options: ["Cranial", "Abdominal", "Spinal", "Thoracic"], answer: "Thoracic" },
                { type: "multiple-choice", topic: "Gland Pathology", questionText: "A malignant tumor that occurs in glandular tissue is a(n):", options: ["Adenoma", "Adenocarcinoma", "Adenosis", "Adenitis"], answer: "Adenocarcinoma" },
                { type: "multiple-choice", topic: "Tissues", questionText: "Which of these is NOT one of the four main types of tissue?", options: ["Epithelial", "Connective", "Skeletal", "Muscular"], answer: "Skeletal" },
                { type: "multiple-choice", topic: "Body Cavities", questionText: "The multilayered membrane that protects the organs in the abdomen is the:", options: ["Pleura", "Pericardium", "Peritoneum", "Mesentery"], answer: "Peritoneum" },
                { type: "fill-in-the-blank", topic: "Disease Transmission", questionText: "A disease-producing microorganism is called a _________.", answer: "Pathogen" },
                { type: "fill-in-the-blank", topic: "Pathology", questionText: "The study of the cause of a disease is called _________.", answer: "Etiology" },
                { type: "fill-in-the-blank", topic: "Genetics", questionText: "A change within the body's cells that cannot be transmitted to the next generation is a _________ cell mutation.", answer: "somatic" },
                { type: "fill-in-the-blank", topic: "Disease Transmission", questionText: "A disease that can be transmitted from one person to another is called a _________ disease.", answer: "Communicable" },
                { type: "fill-in-the-blank", topic: "Genetics", questionText: "The fundamental physical and functional unit of heredity is the _________.", answer: "Gene" },
                { type: "true-false", topic: "Genetics", questionText: "True or False: A dominant gene must be inherited from both parents for a trait to appear.", answer: false },
                { type: "true-false", topic: "Body Cavities", questionText: "True or False: The peritoneum is the membrane that protects the organs within the thoracic cavity.", answer: false },
                { type: "true-false", topic: "Cell Pathology", questionText: "True or False: `Hypoplasia` is the incomplete development of an organ or tissue.", answer: true },
                { type: "true-false", topic: "Genetics", questionText: "True or False: A recessive gene will only appear if inherited from one parent.", answer: false },
                { type: "true-false", topic: "Body Cavities", questionText: "True or False: The Dorsal Cavity contains the heart and lungs.", answer: false },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Dissect the term 'hyperplasia'.", answer: { prefix: "hyper", root: "plas", suffix: "ia" }, hint: "Prefix means excessive, root means formation." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Dissect the term 'adenosclerosis'.", answer: { root: "aden", suffix: "sclerosis" }, hint: "Root means gland, suffix means abnormal hardening." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Dissect the term 'cytology'.", answer: { root: "cyt/o", suffix: "logy" }, hint: "Root means cell, suffix means study of." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Dissect the term 'hypoplasia'.", answer: { prefix: "hypo", root: "plas", suffix: "ia" }, hint: "Prefix means deficient, root means formation." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "Dissect the term 'anaplasia'.", answer: { prefix: "ana", root: "plas", suffix: "ia" }, hint: "Prefix means backward, root means formation." },
                { type: "matching", topic: "Cell Pathology", questionText: "Match the pathology term to its definition.", terms: ["Anaplasia", "Dysplasia", "Hyperplasia", "Hypoplasia"], definitions: ["Change in cell structure", "Abnormal development", "Increase in the number of cells", "Incomplete development"], answer: { "Anaplasia": "Change in cell structure", "Dysplasia": "Abnormal development", "Hyperplasia": "Increase in the number of cells", "Hypoplasia": "Incomplete development" }},
                { type: "matching", topic: "Gland Pathology", questionText: "Match the `aden/o` term to its definition.", terms: ["Adenitis", "Adenoma", "Adenectomy", "Adenosclerosis"], definitions: ["Inflammation of a gland", "A benign tumor of a gland", "Surgical removal of a gland", "Abnormal hardening of a gland"], answer: { "Adenitis": "Inflammation of a gland", "Adenoma": "A benign tumor of a gland", "Adenectomy": "Surgical removal of a gland", "Adenosclerosis": "Abnormal hardening of a gland" }},
                { type: "matching", topic: "Tissues", questionText: "Match the tissue type to its function.", terms: ["Epithelial", "Connective", "Muscular", "Nervous"], definitions: ["Covers body surfaces", "Supports and connects", "Contracts and relaxes", "Conducts electrical impulses"], answer: { "Epithelial": "Covers body surfaces", "Connective": "Supports and connects", "Muscular": "Contracts and relaxes", "Nervous": "Conducts electrical impulses" }},
                { type: "matching", topic: "Body Cavities", questionText: "Match the cavity to the organ system it primarily contains.", terms: ["Cranial", "Spinal", "Thoracic", "Abdominal"], definitions: ["Brain", "Spinal Cord", "Heart/Lungs", "Digestion"], answer: { "Cranial": "Brain", "Spinal": "Spinal Cord", "Thoracic": "Heart/Lungs", "Abdominal": "Digestion" }},
                { type: "matching", topic: "Disease Transmission", questionText: "Match the transmission method to its description.", terms: ["Bloodborne", "Airborne", "Vector-borne"], definitions: ["Spread through contact with infected blood", "Spread through respiratory droplets", "Spread by an insect or animal"], answer: { "Bloodborne": "Spread through contact with infected blood", "Airborne": "Spread through respiratory droplets", "Vector-borne": "Spread by an insect or animal" }}
            ]
        },
        Advanced: {
            questions: [
                { type: "multiple-choice", topic: "Healthcare Units", questionText: "A patient with a heart condition that needs continuous monitoring but does NOT require intensive care would be placed in a:", options: ["ICU", "Medical/Surgical Unit", "Telemetry Unit", "Emergency Room"], answer: "Telemetry Unit"},
                { type: "multiple-choice", topic: "Healthcare Professionals", questionText: "Which professional's primary role is NOT direct, hands-on patient care?", options: ["Registered Nurse", "Certified Nursing Assistant", "Medical Coder", "Physician Assistant"], answer: "Medical Coder"},
                { type: "multiple-choice", topic: "Disease Outbreaks", questionText: "Which of the following describes a disease outbreak that occurs over a large geographic area, such as several countries or continents?", options: ["Endemic", "Epidemic", "Pandemic", "Functional"], answer: "Pandemic"},
                { type: "multiple-choice", topic: "Pathology", questionText: "An illness without a known cause is described as:", options: ["Iatrogenic", "Idiopathic", "Congenital", "Nosocomial"], answer: "Idiopathic"},
                { type: "multiple-choice", topic: "Healthcare Professionals", questionText: "Which physician specializes in the care of critically ill patients, typically in an ICU?", options: ["Hospitalist", "Intensivist", "General Practitioner", "Geriatrician"], answer: "Intensivist"},
                { type: "fill-in-the-blank", topic: "Disease Outbreaks", questionText: "A sudden and widespread outbreak of a disease within a specific population group is a(n) _________.", answer: "epidemic" },
                { type: "fill-in-the-blank", topic: "Healthcare Professionals", questionText: "A physician who specializes in diagnosing and treating disorders of the internal organs is a(n) _________.", answer: "Internist" },
                { type: "fill-in-the-blank", topic: "Healthcare Professionals", questionText: "A licensed professional who works under the supervision of a physician is a physician _________.", answer: "assistant" },
                { type: "fill-in-the-blank", topic: "Pathology", questionText: "An illness produced by a medical treatment or examination is known as an _________ illness.", answer: "iatrogenic" },
                { type: "fill-in-the-blank", topic: "Disease Outbreaks", questionText: "The ongoing presence of a disease within a population, group, or area is known as _________.", answer: "endemic" },
                { type: "true-false", topic: "Disease Transmission", questionText: "True or False: A nosocomial infection is one that a patient has upon admission to a hospital.", answer: false },
                { type: "true-false", topic: "Genetics", questionText: "True or False: A gametic cell mutation can be transmitted to offspring.", answer: true },
                { type: "true-false", topic: "Healthcare Professionals", questionText: "True or False: A Certified Nursing Assistant (CNA) typically has more advanced training than a Registered Nurse (RN).", answer: false },
                { type: "true-false", topic: "Pathology", questionText: "True or False: A 'functional disorder' is a type of disease outbreak.", answer: false },
                { type: "true-false", topic: "Cell Pathology", questionText: "True or False: `Hypertrophy` is an increase in the number of cells in an organ or tissue.", answer: false },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "A patient is diagnosed with an 'adenoma'. The suffix '-oma' indicates what?", answer: { suffix: "tumor" }, hint: "This suffix is common in pathology." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "In the term 'histology', the root 'hist/o' means what?", answer: { root: "tissue" }, hint: "The study of tissues." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "The term 'pathology' contains the root 'path/o', which means:", answer: { root: "disease" }, hint: "The study of disease." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "The suffix in 'adenocarcinoma' ('-carcinoma') indicates what type of tumor?", answer: { suffix: "malignant" }, hint: "This indicates cancer." },
                { type: "word-dissection", topic: "Word Breakdown", questionText: "In the term 'geriatrician', the root 'geriatr/o' refers to:", answer: { root: "old age" }, hint: "A specialist in the care of older people." },
                { type: "case-study", topic: "Clinical Cases", questionText: "A worldwide outbreak of a new influenza virus is declared. This is classified as a(n):", options: ["Epidemic", "Pandemic", "Endemic", "Exotic"], answer: "Pandemic" },
                { type: "case-study", topic: "Pathology Analysis", questionText: "A patient's tissue sample shows a change in the structure of cells and their orientation, a characteristic of tumors. This is known as:", options: ["Hypoplasia", "Anaplasia", "Aplasia", "Hypertrophy"], answer: "Anaplasia"},
                { type: "case-study", topic: "Clinical Cases", questionText: "A patient in the hospital for surgery develops a new infection. This type of hospital-acquired infection is called:", options: ["Hereditary", "Idiopathic", "Nosocomial", "Congenital"], answer: "Nosocomial" },
                { type: "case-study", topic: "Healthcare Professionals", questionText: "An 8-year-old child is taken for a routine check-up. The physician they see is a:", options: ["Geriatrician", "Internist", "Pediatrician", "Hospitalist"], answer: "Pediatrician" },
                { type: "case-study", topic: "Clinical Cases", questionText: "A patient arrives at the emergency room after a car accident. The licensed professional who provided medical care in the ambulance is a(n):", options: ["Registered Nurse", "Emergency Medical Technician", "Physician Assistant", "Medical Assistant"], answer: "Emergency Medical Technician"},
                { type: "matching", topic: "Healthcare Professionals", questionText: "Match the healthcare professional to their primary work environment.", terms: ["Intensivist", "Hospitalist", "EMT", "Geriatrician"], definitions: ["Intensive Care Unit (ICU)", "General Medical/Surgical Unit", "Pre-hospital setting (ambulance)", "Outpatient clinic or long-term care"], answer: { "Intensivist": "Intensive Care Unit (ICU)", "Hospitalist": "General Medical/Surgical Unit", "EMT": "Pre-hospital setting (ambulance)", "Geriatrician": "Outpatient clinic or long-term care" }},
                { type: "matching", topic: "Healthcare Professionals", questionText: "Match the professional to their license/supervision level.", terms: ["Physician Assistant", "Licensed Vocational Nurse", "Certified Nursing Assistant"], definitions: ["Works under the supervision of a physician", "Works under a doctor or RN", "Provides basic patient care"], answer: { "Physician Assistant": "Works under the supervision of a physician", "Licensed Vocational Nurse": "Works under a doctor or RN", "Certified Nursing Assistant": "Provides basic patient care" }},
                { type: "matching", topic: "Disease Outbreaks", questionText: "Match the disease outbreak term to its scope.", terms: ["Endemic", "Epidemic", "Pandemic"], definitions: ["Constantly present in a population", "A sudden widespread outbreak in an area", "A worldwide outbreak"], answer: { "Endemic": "Constantly present in a population", "Epidemic": "A sudden widespread outbreak in an area", "Pandemic": "A worldwide outbreak" }},
                { type: "matching", topic: "Pathology", questionText: "Match the term to its meaning.", terms: ["Iatrogenic", "Idiopathic", "Congenital"], definitions: ["Caused by medical treatment", "Without known cause", "Present at birth"], answer: { "Iatrogenic": "Caused by medical treatment", "Idiopathic": "Without known cause", "Congenital": "Present at birth" }},
                { type: "matching", topic: "Healthcare Units", questionText: "Match the healthcare unit to its purpose.", terms: ["ICU", "Telemetry Unit", "Medical/Surgical Unit"], definitions: ["Continuous monitoring of critically ill patients", "Continuous cardiac monitoring for non-critical patients", "Nursing care for lower-acuity patients"], answer: { "ICU": "Continuous monitoring of critically ill patients", "Telemetry Unit": "Continuous cardiac monitoring for non-critical patients", "Medical/Surgical Unit": "Nursing care for lower-acuity patients" }}
            ]
        }
    };

    let gameState = {};

    function showScreen(screenId) { screens.forEach(s => s.style.display = s.id === screenId ? 'block' : 'none'); }
    function shuffleArray(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]]; } return a; }
    function formatTime(s) { const m = Math.floor(s / 60); const sec = s % 60; return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`; }

    function resetGameState() {
        if (gameState.timerInterval) clearInterval(gameState.timerInterval);
        speechSynthesis.cancel();
        gameState = {
            level: '', questions: [], currentQuestionIndex: 0, score: 0, time: 0,
            timerInterval: null, answeredQuestions: []
        };
    }

    function startQuiz(level) {
        resetGameState();
        gameState.level = level;
        const shuffleEnabled = document.getElementById('shuffleSwitch').checked;
        let questionsForLevel = JSON.parse(JSON.stringify(staticQuizzes[level].questions));
        if (shuffleEnabled) {
            gameState.questions = shuffleArray(questionsForLevel);
        } else {
            gameState.questions = questionsForLevel;
        }
        showScreen('gameScreen');
        startTimer();
        displayQuestion();
    }
    
    function startTimer() {
        if (gameState.timerInterval) clearInterval(gameState.timerInterval);
        gameState.timerInterval = setInterval(() => { gameState.time++; timerEl.textContent = formatTime(gameState.time); }, 1000);
    }
    
    function pauseGame() {
        clearInterval(gameState.timerInterval);
        pauseOverlay.classList.add('active');
    }

    function resumeGame() {
        pauseOverlay.classList.remove('active');
        startTimer();
    }

    function displayQuestion() {
        speechSynthesis.cancel();
        if (gameState.currentQuestionIndex >= gameState.questions.length) {
            endGame(); return;
        }
        const q = gameState.questions[gameState.currentQuestionIndex];
        gameArea.innerHTML = '';
        
        switch (q.type) {
            case 'multiple-choice':
            case 'case-study':
            case 'outlier':
            case 'term-construction':
                renderMultipleChoice(q);
                break;
            case 'matching':
                renderMatching(q);
                break;
            case 'fill-in-the-blank':
                renderFillInTheBlank(q);
                break;
            case 'true-false':
                renderTrueFalse(q);
                break;
            case 'word-dissection':
                renderWordDissection(q);
                break;
        }

        updateStats();
        submitBtn.disabled = true;
        readAloudBtn.onclick = () => { 
            let textToSpeak = q.questionText;
            if (q.options) {
                textToSpeak += ". The options are: " + q.options.join(', ');
            } else if (q.type === 'true-false') {
                textToSpeak += ". The options are: True, or False.";
            } else if (q.type === 'matching') {
                textToSpeak += ". The items to match are: " + q.terms.join(', ');
            }
            speechSynthesis.speak(new SpeechSynthesisUtterance(textToSpeak));
         };
    }

    function renderMultipleChoice(q) {
        gameArea.innerHTML = `<p class="question-text">${q.questionText}</p><div class="options-grid">${shuffleArray([...q.options]).map(opt => `<div class="option" data-value="${opt}">${opt}</div>`).join('')}</div>`;
        document.querySelectorAll('.option').forEach(opt => opt.addEventListener('click', () => {
            document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            submitBtn.disabled = false;
        }));
    }

    function renderTrueFalse(q) {
        gameArea.innerHTML = `<p class="question-text">${q.questionText}</p>
            <div class="true-false-container">
                <button class="btn btn-primary btn-tf" data-value="true">True</button>
                <button class="btn btn-primary btn-tf" data-value="false">False</button>
            </div>`;
        document.querySelectorAll('.btn-tf').forEach(btn => btn.addEventListener('click', () => {
             document.querySelectorAll('.btn-tf').forEach(b => b.classList.remove('selected'));
             btn.classList.add('selected');
             submitBtn.disabled = false;
        }));
    }
    
    function renderFillInTheBlank(q) {
        const parts = q.questionText.split('_________');
        gameArea.innerHTML = `<div class="fill-in-the-blank-container">
            <p class="question-text">${parts[0]}<span class="fill-in-the-blank-wrapper"><input type="text" id="fillBlankInput" class="styled-input" placeholder="Type answer"></span>${parts[1] || ''}</p>
        </div>`;
        document.getElementById('fillBlankInput').addEventListener('input', () => {
             submitBtn.disabled = document.getElementById('fillBlankInput').value.trim() === '';
        });
    }

    function renderWordDissection(q) {
        gameArea.innerHTML = `<p class="question-text">${q.questionText}</p>
            <div class="word-dissection-container">
                <div class="dissection-grid">
                    ${'prefix' in q.answer ? `<div class="dissection-group"><label>Prefix</label><input type="text" id="prefixInput" class="styled-input"></div>` : ''}
                    ${'root' in q.answer ? `<div class="dissection-group"><label>Root</label><input type="text" id="rootInput" class="styled-input"></div>` : ''}
                    ${'suffix' in q.answer ? `<div class="dissection-group"><label>Suffix</label><input type="text" id="suffixInput" class="styled-input"></div>` : ''}
                </div>
                ${q.hint ? `<p style="font-size:0.9em; opacity:0.7; margin-top:15px;">Hint: ${q.hint}</p>` : ''}
            </div>`;
        document.querySelectorAll('.styled-input').forEach(input => input.addEventListener('input', () => {
            submitBtn.disabled = false;
        }));
    }

    function renderMatching(q) {
        const termsHTML = shuffleArray([...q.terms]).map(term => `<div class="match-item" draggable="true" data-term="${term}">${term}</div>`).join('');
        const defsHTML = q.definitions.map(def => `<div class="drop-zone" data-definition="${def}">${def}</div>`).join('');
        gameArea.innerHTML = `<p class="question-text">${q.questionText}</p><div class="matching-container"><div class="match-column bank">${termsHTML}</div><div class="match-column">${defsHTML}</div></div>`;
        setupDragAndDrop();
    }

    function setupDragAndDrop() {
        const draggables = document.querySelectorAll('.match-item');
        const dropZones = document.querySelectorAll('.match-column, .drop-zone');
        let draggedItem = null;

        draggables.forEach(d => {
            d.addEventListener('dragstart', () => { draggedItem = d; setTimeout(() => d.classList.add('dragging'), 0); });
            d.addEventListener('dragend', () => { d.classList.remove('dragging'); if (Array.from(document.querySelectorAll('.bank .match-item')).length === 0) { submitBtn.disabled = false; }});
        });

        dropZones.forEach(zone => {
            zone.addEventListener('dragover', e => { e.preventDefault(); if(zone.children.length === 0 || zone.classList.contains('bank')) { zone.classList.add('drag-over'); } });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', e => {
                e.preventDefault(); zone.classList.remove('drag-over');
                if (zone.children.length > 0 && !zone.classList.contains('bank')) { return; }
                zone.appendChild(draggedItem);
            });
        });
    }

    function updateStats() {
        scoreEl.textContent = Math.round(gameState.score);
        progressTextEl.textContent = `${gameState.currentQuestionIndex + 1}/${gameState.questions.length}`;
        progressFillEl.style.width = `${((gameState.currentQuestionIndex + 1) / gameState.questions.length) * 100}%`;
    }

    function checkAnswer() {
        const q = gameState.questions[gameState.currentQuestionIndex];
        let isCorrect = false;

        switch (q.type) {
            case 'multiple-choice':
            case 'case-study':
            case 'outlier':
            case 'term-construction':
                const selected = document.querySelector('.option.selected');
                if (!selected) return;
                isCorrect = selected.dataset.value.toLowerCase() === q.answer.toLowerCase();
                if(isCorrect) gameState.score += 10;
                selected.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (!isCorrect) document.querySelectorAll('.option').forEach(opt => { if (opt.dataset.value.toLowerCase() === q.answer.toLowerCase()) opt.classList.add('correct'); });
                break;
            case 'true-false':
                const selectedBtn = document.querySelector('.btn-tf.selected');
                 if (!selectedBtn) return;
                isCorrect = (selectedBtn.dataset.value === 'true') === q.answer;
                if(isCorrect) gameState.score += 10;
                selectedBtn.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (!isCorrect) {
                    document.querySelectorAll('.btn-tf').forEach(btn => {
                        if ((btn.dataset.value === 'true') === q.answer) {
                            btn.classList.add('correct');
                        }
                    });
                }
                break;
            case 'fill-in-the-blank':
                const inputEl = document.getElementById('fillBlankInput');
                const wrapper = document.querySelector('.fill-in-the-blank-wrapper');
                isCorrect = inputEl.value.trim().toLowerCase() === q.answer.toLowerCase();
                if(isCorrect) gameState.score += 10;
                inputEl.style.backgroundColor = isCorrect ? '#d4edda' : '#f8d7da';
                if (!isCorrect) {
                    const feedback = document.createElement('span');
                    feedback.className = 'correct-answer-feedback';
                    feedback.textContent = `(${q.answer})`;
                    wrapper.appendChild(feedback);
                }
                break;
            case 'word-dissection':
                 isCorrect = true;
                 const prefixInput = document.getElementById('prefixInput');
                 const rootInput = document.getElementById('rootInput');
                 const suffixInput = document.getElementById('suffixInput');

                 if (prefixInput && 'prefix' in q.answer) {
                     if (prefixInput.value.trim().toLowerCase() !== q.answer.prefix) {
                        prefixInput.style.backgroundColor = '#f8d7da';
                        if(!prefixInput.value) prefixInput.placeholder = `Ans: ${q.answer.prefix}`;
                        isCorrect = false;
                     } else {
                        prefixInput.style.backgroundColor = '#d4edda';
                     }
                 }
                 if (rootInput && 'root' in q.answer) {
                     if (rootInput.value.trim().toLowerCase() !== q.answer.root) {
                        rootInput.style.backgroundColor = '#f8d7da';
                        if(!rootInput.value) rootInput.placeholder = `Ans: ${q.answer.root}`;
                        isCorrect = false;
                     } else {
                        rootInput.style.backgroundColor = '#d4edda';
                     }
                 }
                 if (suffixInput && 'suffix' in q.answer) {
                     if (suffixInput.value.trim().toLowerCase() !== q.answer.suffix) {
                        suffixInput.style.backgroundColor = '#f8d7da';
                        if(!suffixInput.value) suffixInput.placeholder = `Ans: ${q.answer.suffix}`;
                        isCorrect = false;
                     } else {
                        suffixInput.style.backgroundColor = '#d4edda';
                     }
                 }
                 if(isCorrect) gameState.score += 10;
                 break;
            case 'matching':
                let correctMatches = 0;
                const totalMatches = Object.keys(q.answer).length;
                document.querySelectorAll('.drop-zone').forEach(z => {
                    const termItem = z.querySelector('.match-item');
                    if (termItem && q.answer[termItem.dataset.term] === z.dataset.definition) {
                        correctMatches++; 
                        z.style.borderColor = 'var(--correct-color)';
                        termItem.style.borderColor = 'var(--correct-color)';
                    } else if (termItem) { 
                        z.style.borderColor = 'var(--incorrect-color)'; 
                        termItem.style.borderColor = 'var(--incorrect-color)';
                    }
                });
                isCorrect = correctMatches === totalMatches;
                if (correctMatches > 0) {
                    gameState.score += (correctMatches / totalMatches) * 10;
                }
                break;
        }
        
        gameState.answeredQuestions.push({ question: q, isCorrect: isCorrect });
        updateStats();
        document.querySelectorAll('.option, .match-item, .styled-input, .btn-tf').forEach(el => el.style.pointerEvents = 'none');
        submitBtn.disabled = true;
        setTimeout(() => { gameState.currentQuestionIndex++; displayQuestion(); }, isCorrect ? 2000 : 3000);
    }
    
    function endGame(forceEnd = false) {
        clearInterval(gameState.timerInterval);
        speechSynthesis.cancel();
        showScreen('resultsScreen');

        const questionsAttempted = gameState.answeredQuestions.length;
        const correctAnswers = gameState.answeredQuestions.filter(q => q.isCorrect).length;
        
        finalScoreEl.textContent = Math.round(gameState.score);
        finalQuestionsEl.textContent = `${correctAnswers}/${questionsAttempted}`;
        finalTimeEl.textContent = formatTime(gameState.time);

        if (questionsAttempted === 0) {
            resultsMessage.textContent = "You didn't answer any questions.";
            improvementSection.style.display = 'none';
            reviewBtn.style.display = 'none';
            return;
        }
        
        reviewBtn.style.display = 'inline-block';
        const accuracy = Math.round((correctAnswers / questionsAttempted) * 100);
        if (accuracy === 100) { resultsTitle.textContent = "Excellent!"; resultsMessage.textContent = "Perfect score. Great job!"; }
        else if (accuracy >= 70) { resultsTitle.textContent = "Well Done!"; resultsMessage.textContent = "Solid understanding of the material."; }
        else { resultsTitle.textContent = "Good Effort!"; resultsMessage.textContent = "Review your weak areas and try again."; }

        const incorrectTopics = new Set(gameState.answeredQuestions.filter(q => !q.isCorrect).map(q => q.question.topic));
        if (incorrectTopics.size > 0) {
            improvementSection.style.display = 'block';
            topicTags.innerHTML = [...incorrectTopics].map(topic => `<span class="topic-tag">${topic}</span>`).join('');
        } else {
            improvementSection.style.display = 'none';
        }

        populateReview();
    }
    
    function populateReview() {
        reviewContainer.innerHTML = '<h3>Answer Review</h3>';
        gameState.answeredQuestions.forEach(item => {
            const correctAnsString = (q) => {
                if (typeof q.answer === 'object') {
                    if(q.type === 'word-dissection') {
                        let parts = [];
                        if(q.answer.prefix) parts.push(`Prefix: ${q.answer.prefix}`);
                        if(q.answer.root) parts.push(`Root: ${q.answer.root}`);
                        if(q.answer.suffix) parts.push(`Suffix: ${q.answer.suffix}`);
                        return parts.join(', ');
                    }
                    return "See matched pairs";
                }
                return q.answer;
            };

            const reviewItem = document.createElement('div');
            reviewItem.className = 'review-item';
            reviewItem.innerHTML = `
                <div class="review-item-status">${item.isCorrect ? '✔️' : '❌'}</div>
                <div class="review-item-text">
                    <p>${item.question.questionText}</p>
                    <span>Correct Answer: ${correctAnsString(item.question)}</span>
                </div>
            `;
            reviewContainer.appendChild(reviewItem);
        });
    }
    
    function toggleReview() {
        const isHidden = reviewContainer.style.display === 'none' || reviewContainer.style.display === '';
        reviewContainer.style.display = isHidden ? 'block' : 'none';
        reviewBtn.textContent = isHidden ? 'Hide Review' : 'Review Answers';
    }

    function showMenu() { 
        resetGameState(); 
        reviewContainer.style.display = 'none';
        reviewBtn.textContent = 'Review Answers';
        showScreen('menuScreen'); 
    }
</script>

</body>
</html>